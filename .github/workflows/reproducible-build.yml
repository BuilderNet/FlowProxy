name: reproducible-build

on:
  workflow_dispatch: {}
  schedule:
    - cron: "0 1 */2 * *"

jobs:
  build:
    name: build reproducible binaries
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - uses: rui314/setup-mold@v1
      - uses: extractions/setup-just@v3
      - uses: dtolnay/rust-toolchain@stable
        with:
          target: x86_64-unknown-linux-gnu
      - name: Install cargo-cache
        run: |
          cargo install cargo-cache
      - name: Build reproducible binary
        run: |
          just build-reproducible
          mv target/x86_64-unknown-linux-gnu/reproducible/buildernet-orderflow-proxy buildernet-orderflow-proxy-1
      - name: Clean cache
        run: cargo clean && cargo cache -a
      - name: Build reproducible binary again
        run: |
          just build-reproducible
          mv target/x86_64-unknown-linux-gnu/reproducible/buildernet-orderflow-proxy buildernet-orderflow-proxy-2
      - name: Compare binaries
        run: cmp buildernet-orderflow-proxy-1 buildernet-orderflow-proxy-2
