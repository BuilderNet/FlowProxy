# IMPORTANT: MUST MIRROR PRODUCTION CONFIGURATION FOR THE TESTS TO BE USEFUL.
global
  # Maximum number of concurrent connections
  maxconn 4096
  # System limits configuration
  ulimit-n 32768

  # Emit logs to stdout for Docker-friendly collection
  log stdout format raw local0 info
  log stdout format raw local1 notice

  # CHANGE: Default is 16 KiB, set to 1 MiB
  tune.h2.initial-window-size 4194304

  # CHANGE: Default is 1.6 MiB, set to 100 MiB
  tune.h2.fe.rxbuf 104857600

defaults
  mode http
  timeout connect 5s
  timeout client 30s
  timeout server 30s
  timeout http-request 2s
  timeout http-keep-alive 10s
  log global

  compression algo gzip
  compression type text/html text/plain application/json

frontend default
  bind *:80
  # CHANGE: Allow connections without SNI (IP access) by removing strict-sni
  bind *:443 ssl crt /usr/local/etc/haproxy/certs/

  # CHANGE: Don't force HTTPS redirect
  # http-request redirect scheme https code 301 unless { ssl_fc }

  # Stick table to track connections and bandwidth
  stick-table type ip size 100k expire 5m store conn_rate(10s),bytes_in_rate(1m),conn_cur,http_req_rate(10s)

  # Track client in stick table
  http-request track-sc0 src

  http-request return status 200 content-type text/plain string "OK\n" if { path '/livez' }

  default_backend user_of

frontend system
  # CHANGE: Allow connections without SNI (IP access) by removing strict-sni
  bind *:5544 ssl crt /usr/local/etc/haproxy/certs/

  http-request return status 200 content-type application/json string '{"system_api_port": 5554}' if { path /infoz }

  default_backend system_of

frontend system2
  mode tcp
  log global
  option tcplog
  bind *:5554 ssl crt /usr/local/etc/haproxy/certs/
  default_backend system2_backend

# frontend prometheus
#   bind 0.0.0.0:8405
#   http-request use-service prometheus-exporter if { path /metrics }
#   no log

# frontend public_cert
#   bind 127.0.0.1:14727
#   http-request return status 200 content-type text/plain file "/usr/local/etc/haproxy/static/le.cer"

backend user_of
  http-reuse always

  option httpchk GET /livez
  http-check expect status 200
  server user_of1 127.0.0.1:5543 check inter 5s fall 3 rise 1

backend system_of
  http-reuse always

  option httpchk GET /livez
  http-check expect status 200
  server system_of1 127.0.0.1:5542 check inter 5s fall 3 rise 1

backend system2_backend
  mode tcp
  log global
#   server system2_server 127.0.0.1:5552 check inter 5s fall 3 rise 1
  server system2_server 127.0.0.1:5552
